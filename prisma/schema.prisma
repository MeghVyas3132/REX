// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  name         String
  role         String    @default("user")
  apiKey       String?   @unique @map("api_key")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Core Relations for AI Agent Workflows
  workflows    Workflow[]
  workflowRuns WorkflowRun[]
  agents       Agent[]
  agentRuns    AgentRun[]
  credentials  Credential[]
  webhooks     Webhook[]
  prompts      Prompt[]      // For prompt templates
  analytics    Analytics[]   // Basic usage analytics
  emailData    EmailData[]   // Email data entries
  auditLogs    AuditLog[]    // Audit log entries

  @@map("users")
}

model Workflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  nodes       Json     @default("[]")
  edges       Json     @default("[]")
  settings    Json     @default("{}")
  isActive    Boolean  @default(false) @map("is_active")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs        WorkflowRun[]
  webhooks    Webhook[]

  @@map("workflows")
}

model WorkflowRun {
  id            String    @id @default(uuid())
  workflowId    String    @map("workflow_id")
  status        String    @default("pending")
  input         Json      @default("{}")
  output        Json?
  error         String?
  nodeResults   Json      @default("{}") @map("node_results")
  executionOrder Json     @default("[]") @map("execution_order")
  nodeOutputs   Json      @default("{}") @map("node_outputs")
  runOptions    Json      @default("{}") @map("run_options")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  duration      Int?      // in milliseconds
  userId        String?   @map("user_id")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  workflow      Workflow           @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  user          User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  events        WorkflowRunEvent[]

  @@map("workflow_runs")
}

model WorkflowRunEvent {
  id        String      @id @default(uuid())
  runId     String      @map("run_id")
  eventType String      @map("event_type")
  nodeId    String?     @map("node_id")
  payload   Json?
  ts        BigInt
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  run       WorkflowRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("workflow_run_events")
}

model Agent {
  id           String    @id @default(uuid())
  name         String
  description  String?
  model        String    @default("gpt-4o-mini")
  instructions String?
  tools        Json      @default("[]")
  settings     Json      @default("{}")
  isActive     Boolean   @default(false) @map("is_active")
  userId       String    @map("user_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs         AgentRun[]

  @@map("agents")
}

model AgentRun {
  id        String    @id @default(uuid())
  agentId   String    @map("agent_id")
  status    String    @default("queued")
  input     Json      @default("{}")
  output    Json?
  error     String?
  userId    String?   @map("user_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  agent      Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user       User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages   AgentMessage[]

  @@map("agent_runs")
}

model AgentMessage {
  id        String    @id @default(uuid())
  runId     String    @map("run_id")
  role      String
  content   Json
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  run       AgentRun  @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("agent_messages")
}

model Credential {
  id           String   @id @default(uuid())
  name         String
  type         String
  encryptedData String  @map("encrypted_data")
  userId       String   @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credentials")
}

model Webhook {
  id         String   @id @default(uuid())
  workflowId String   @map("workflow_id")
  name       String
  url        String
  method     String   @default("POST")
  headers    Json     @default("{}")
  secret     String?
  eventTypes Json     @default("[]") @map("event_types")
  isActive   Boolean  @default(true) @map("is_active")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  workflow   Workflow       @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  events     WebhookEvent[]

  @@map("webhooks")
}

model WebhookEvent {
  id        String   @id @default(uuid())
  webhookId String   @map("webhook_id")
  event     String
  payload   Json
  headers   Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_events")
}

model QueueJob {
  id          String    @id @default(uuid())
  type        String
  data        Json
  options     Json      @default("{}")
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  delay       Int       @default(0)
  priority    Int       @default(0)
  processedAt DateTime? @map("processed_at")
  failedAt    DateTime? @map("failed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("queue_jobs")
}

// Essential AI Agent Workflow Models

// Prompt Templates for AI Agents
model Prompt {
  id          String   @id @default(uuid())
  name        String
  description String?
  content     String
  variables   Json     @default("[]")  // Template variables
  category    String?  // ai, automation, data-processing
  tags        Json     @default("[]")
  isPublic    Boolean  @default(false) @map("is_public")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("prompts")
}

// Basic Analytics for Workflow Usage
model Analytics {
  id        String   @id @default(uuid())
  type      String   // workflow, agent, node
  entityId  String   @map("entity_id")
  metric    String   // runs, success_rate, avg_duration
  value     Float
  metadata  Json     @default("{}")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("analytics")
}

// Email Data for Email Automation Workflow
model EmailData {
  id             String    @id @default(uuid())
  eventId        String    @unique @map("event_id")
  recipientEmail String    @map("recipient_email")
  recipientName  String?   @map("recipient_name")
  senderEmail    String    @map("sender_email")
  senderName     String?   @map("sender_name")
  subject        String
  bodyHtml       String?   @map("body_html") @db.Text
  bodyText       String?   @map("body_text") @db.Text
  templateId     String?   @map("template_id")
  campaignId     String?   @map("campaign_id")
  attachments    Json      @default("[]")
  formInputs     Json      @default("{}") @map("form_inputs")
  triggerSource  String?   @map("trigger_source")
  userId         String?   @map("user_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user           User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([userId])
  @@index([templateId])
  @@index([campaignId])
  @@map("email_data")
}

// Audit Logs for Email Automation and General Workflow Logging
model AuditLog {
  id         String    @id @default(uuid())
  type       String    // success, error, info, warning
  event      String
  workflowId String?   @map("workflow_id")
  runId      String?   @map("run_id")
  nodeId     String?   @map("node_id")
  userId     String?   @map("user_id")
  data       Json      @default("{}")
  metadata   Json      @default("{}")
  timestamp  DateTime  @default(now())
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime? @updatedAt @map("updated_at")

  // Relations
  user       User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([event])
  @@index([workflowId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}